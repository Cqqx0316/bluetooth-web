<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基础蓝牙数据显示</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        button {
            padding: 10px 20px;
            margin: 10px 0;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:disabled {
            background-color: #cccccc;
        }
        #log {
            height: 150px;
            border: 1px solid #ddd;
            padding: 10px;
            overflow-y: auto;
            margin-bottom: 20px;
            background-color: #f9f9f9;
        }
        .data-container {
            margin-top: 20px;
        }
        .data-item {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f0f0f0;
            border-left: 4px solid #4CAF50;
        }
        .label {
            font-weight: bold;
        }
        .raw-data {
            margin-top: 20px;
            padding: 10px;
            background-color: #eee;
            font-family: monospace;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <h1>蓝牙数据接收器</h1>
    
    <button id="connectButton">连接蓝牙设备</button>
    <button id="disconnectButton" disabled>断开连接</button>
    
    <div id="deviceInfo">
        <p>设备名称: <span id="deviceName">未连接</span></p>
        <p>连接状态: <span id="connectionStatus">未连接</span></p>
    </div>
    
    <h2>日志信息</h2>
    <div id="log"></div>
    
    <h2>接收到的数据</h2>
    <div class="data-container">
        <div class="data-item">
            <span class="label">心率:</span> <span id="heartRate">--</span>
        </div>
        <div class="data-item">
            <span class="label">血氧:</span> <span id="spo2">--</span>
        </div>
        <div class="data-item">
            <span class="label">疲劳指数:</span> <span id="fatigue">--</span>
        </div>
        <div class="data-item">
            <span class="label">血压:</span> <span id="bloodPressure">--/--</span>
        </div>
    </div>
    
    <h2>原始数据</h2>
    <div id="rawData" class="raw-data">无数据</div>

    <script>
        // 蓝牙配置
        const serviceUUID = "12345678-1234-5678-1234-56789abcdef0";
        const characteristicUUID = "6d68ef10-1f3a-11ee-be56-0242ac120002";
        
        // DOM元素
        const connectButton = document.getElementById('connectButton');
        const disconnectButton = document.getElementById('disconnectButton');
        const deviceNameElement = document.getElementById('deviceName');
        const connectionStatusElement = document.getElementById('connectionStatus');
        const logElement = document.getElementById('log');
        const heartRateElement = document.getElementById('heartRate');
        const spo2Element = document.getElementById('spo2');
        const fatigueElement = document.getElementById('fatigue');
        const bloodPressureElement = document.getElementById('bloodPressure');
        const rawDataElement = document.getElementById('rawData');
        
        // 全局变量
        let device = null;
        let server = null;
        let characteristic = null;
        
        // 添加日志
        function addLog(message) {
            const logEntry = document.createElement('div');
            logEntry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        // 修改蓝牙连接函数
        async function connectDevice() {
            try {
                addLog('正在请求蓝牙设备...');
                
                // 修改请求设备的方式，更宽松的过滤条件
                device = await navigator.bluetooth.requestDevice({
                    // 使用名称前缀过滤
                    filters: [{ namePrefix: 'ESP32' }],
                    // 声明我们将使用的服务
                    optionalServices: [serviceUUID]
                });
                
                deviceNameElement.textContent = device.name || 'ESP32蓝牙设备';
                addLog(`设备已选择: ${device.name || 'ESP32蓝牙设备'}`);
                
                // 设备断开连接事件处理
                device.addEventListener('gattserverdisconnected', handleDisconnect);
                
                connectionStatusElement.textContent = '正在连接...';
                addLog('正在连接到GATT服务器...');
                
                // 添加超时和重试机制
                server = await connectWithRetry(device);
                addLog('已连接到GATT服务器');
                
                // 等待一小段时间再获取服务
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // 获取服务
                addLog('正在获取蓝牙服务...');
                const service = await server.getPrimaryService(serviceUUID);
                addLog('已获取蓝牙服务');
                
                // 再等待一下
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // 获取特征值
                addLog('正在获取特征值...');
                characteristic = await service.getCharacteristic(characteristicUUID);
                addLog('已获取特征值');
                
                // 启动通知
                addLog('正在启动通知...');
                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', handleNotifications);
                addLog('通知已启动，等待数据...');
                
                connectionStatusElement.textContent = '已连接';
                connectButton.disabled = true;
                disconnectButton.disabled = false;
                
            } catch (error) {
                addLog(`连接错误: ${error.message || error}`);
                console.error('连接错误:', error);
                disconnectDevice();
            }
        }
        
        // 添加连接重试机制
        async function connectWithRetry(device, maxRetries = 3) {
            let retries = 0;
            while (retries < maxRetries) {
                try {
                    addLog(`尝试连接，第 ${retries + 1} 次`);
                    return await device.gatt.connect();
                } catch (error) {
                    retries++;
                    if (retries >= maxRetries) {
                        throw error;
                    }
                    addLog(`连接失败，等待重试... (${retries}/${maxRetries})`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
        }
        
        // 断开连接
        function disconnectDevice() {
            if (device && device.gatt.connected) {
                device.gatt.disconnect();
            } else {
                handleDisconnect();
            }
        }
        
        // 处理断开连接事件
        function handleDisconnect() {
            addLog('设备已断开连接');
            connectionStatusElement.textContent = '未连接';
            deviceNameElement.textContent = '未连接';
            connectButton.disabled = false;
            disconnectButton.disabled = true;
            
            // 清除全局变量
            device = null;
            server = null;
            characteristic = null;
        }
        
        // 处理收到的通知
        function handleNotifications(event) {
            try {
                const value = new TextDecoder().decode(event.target.value);
                addLog(`收到数据: ${value}`);
                rawDataElement.textContent = value;
                
                // 解析数据
                parseNotification(value);
                
            } catch (error) {
                addLog(`解析数据错误: ${error.message}`);
            }
        }
        
        // 解析通知数据 - 更健壮的版本
        function parseNotification(data) {
            try {
                const value = data.trim();
                
                // 记录我们尝试解析的数据
                console.log("尝试解析:", value);
                
                if (value.includes('心率') || value.includes('心率：')) {
                    const match = value.match(/\d+/);
                    if (match) {
                        const heartRate = parseInt(match[0], 10);
                        heartRateElement.textContent = heartRate;
                        addLog(`解析到心率: ${heartRate}`);
                    }
                } else if (value.includes('血氧') || value.includes('血氧：')) {
                    const match = value.match(/\d+/);
                    if (match) {
                        const spo2 = parseInt(match[0], 10);
                        spo2Element.textContent = spo2;
                        addLog(`解析到血氧: ${spo2}`);
                    }
                } else if (value.includes('疲劳指数') || value.includes('疲劳指数：')) {
                    const match = value.match(/\d+/);
                    if (match) {
                        const fatigue = parseInt(match[0], 10);
                        fatigueElement.textContent = fatigue;
                        addLog(`解析到疲劳指数: ${fatigue}`);
                    }
                } else if (value.includes('收缩压') || value.includes('收缩压：')) {
                    const match = value.match(/\d+/);
                    if (match) {
                        const systolic = parseInt(match[0], 10);
                        const diastolic = bloodPressureElement.textContent.split('/')[1] || '--';
                        bloodPressureElement.textContent = `${systolic}/${diastolic}`;
                        addLog(`解析到收缩压: ${systolic}`);
                    }
                } else if (value.includes('舒张压') || value.includes('舒张压：')) {
                    const match = value.match(/\d+/);
                    if (match) {
                        const diastolic = parseInt(match[0], 10);
                        const systolic = bloodPressureElement.textContent.split('/')[0] || '--';
                        bloodPressureElement.textContent = `${systolic}/${diastolic}`;
                        addLog(`解析到舒张压: ${diastolic}`);
                    }
                } else {
                    // 尝试寻找任何匹配的数字模式
                    addLog(`无法识别的数据格式: ${value}`);
                }
            } catch (error) {
                addLog(`解析过程中出错: ${error.message}`);
            }
        }
        
        // 事件监听器
        connectButton.addEventListener('click', connectDevice);
        disconnectButton.addEventListener('click', disconnectDevice);
        
        // 初始化日志
        addLog('网页已加载，点击"连接蓝牙设备"按钮开始');
    </script>
</body>
</html>
