<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32健康数据接收器</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        button {
            padding: 12px 24px;
            margin: 10px 0;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:disabled {
            background-color: #cccccc;
        }
        .status {
            margin: 20px 0;
            padding: 10px;
            background-color: #f0f0f0;
            border-left: 5px solid #4CAF50;
        }
        .data-box {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .data-item {
            display: flex;
            margin: 10px 0;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        .data-label {
            font-weight: bold;
            width: 120px;
        }
        .data-value {
            flex: 1;
        }
        .raw-json {
            margin-top: 20px;
            padding: 10px;
            background-color: #eee;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <h1>ESP32健康数据接收器</h1>
    
    <button id="connect">连接蓝牙设备</button>
    
    <div class="status">
        <div>状态: <span id="connection-status">未连接</span></div>
        <div>设备: <span id="device-name">--</span></div>
    </div>
    
    <div class="data-box">
        <h2>健康数据</h2>
        <div class="data-item">
            <div class="data-label">心率:</div>
            <div class="data-value" id="heart-rate">--</div>
        </div>
        <div class="data-item">
            <div class="data-label">血氧饱和度:</div>
            <div class="data-value" id="spo2">--</div>
        </div>
        <div class="data-item">
            <div class="data-label">疲劳指数:</div>
            <div class="data-value" id="fatigue">--</div>
        </div>
        <div class="data-item">
            <div class="data-label">血压:</div>
            <div class="data-value" id="blood-pressure">--/--</div>
        </div>
    </div>
    
    <div>
        <h2>原始JSON数据</h2>
        <div class="raw-json" id="raw-data">等待数据...</div>
    </div>
    
    <script>
        // 蓝牙配置
        const SERVICE_UUID = "12345678-1234-5678-1234-56789abcdef0";
        const CHARACTERISTIC_UUID = "6d68ef10-1f3a-11ee-be56-0242ac120002";
        
        // 获取DOM元素
        const connectButton = document.getElementById('connect');
        const statusElement = document.getElementById('connection-status');
        const deviceNameElement = document.getElementById('device-name');
        const heartRateElement = document.getElementById('heart-rate');
        const spo2Element = document.getElementById('spo2');
        const fatigueElement = document.getElementById('fatigue');
        const bloodPressureElement = document.getElementById('blood-pressure');
        const rawDataElement = document.getElementById('raw-data');
        
        // 全局变量
        let deviceObj = null;
        let characteristicObj = null;
        
        // 连接按钮事件
        connectButton.addEventListener('click', async () => {
            if (deviceObj && deviceObj.gatt.connected) {
                await disconnect();
                return;
            }
            
            try {
                connectButton.disabled = true;
                statusElement.textContent = "正在搜索设备...";
                
                // 请求蓝牙设备
                deviceObj = await navigator.bluetooth.requestDevice({
                    filters: [
                        { namePrefix: 'ESP32' },
                        { services: [SERVICE_UUID] }
                    ],
                    optionalServices: [SERVICE_UUID]
                });
                
                deviceNameElement.textContent = deviceObj.name || 'ESP32设备';
                statusElement.textContent = "正在连接...";
                
                // 监听断开连接事件
                deviceObj.addEventListener('gattserverdisconnected', onDisconnected);
                
                // 连接到设备
                const server = await deviceObj.gatt.connect();
                statusElement.textContent = "正在获取服务...";
                
                // 获取服务
                const service = await server.getPrimaryService(SERVICE_UUID);
                statusElement.textContent = "正在获取特性...";
                
                // 获取特性
                characteristicObj = await service.getCharacteristic(CHARACTERISTIC_UUID);
                
                // 启用通知
                await characteristicObj.startNotifications();
                characteristicObj.addEventListener('characteristicvaluechanged', handleNotifications);
                
                statusElement.textContent = "已连接，等待数据";
                connectButton.textContent = "断开连接";
                connectButton.disabled = false;
                
            } catch (error) {
                console.error("蓝牙连接错误:", error);
                statusElement.textContent = `连接失败: ${error.message || error}`;
                disconnect();
            }
        });
        
        // 处理接收到的通知
        function handleNotifications(event) {
            try {
                // 获取数据
                const value = event.target.value;
                const decoder = new TextDecoder('utf-8');
                const jsonString = decoder.decode(value);
                
                // 显示原始数据
                rawDataElement.textContent = jsonString;
                
                try {
                    // 尝试解析JSON
                    const data = JSON.parse(jsonString);
                    
                    // 更新UI
                    if (data.heartRate !== undefined) {
                        heartRateElement.textContent = data.heartRate;
                    }
                    
                    if (data.spo2 !== undefined) {
                        spo2Element.textContent = data.spo2;
                    }
                    
                    if (data.fatigue !== undefined) {
                        fatigueElement.textContent = data.fatigue;
                    }
                    
                    if (data.systolic !== undefined && data.diastolic !== undefined) {
                        bloodPressureElement.textContent = `${data.systolic}/${data.diastolic}`;
                    }
                    
                } catch (e) {
                    console.error('解析JSON出错:', e);
                    // 发生错误时仍然显示原始数据
                }
            } catch (error) {
                console.error('处理通知错误:', error);
            }
        }
        
        // 断开连接
        async function disconnect() {
            if (characteristicObj) {
                try {
                    await characteristicObj.stopNotifications();
                } catch (e) {
                    console.log('停止通知失败:', e);
                }
            }
            
            if (deviceObj && deviceObj.gatt.connected) {
                try {
                    deviceObj.gatt.disconnect();
                } catch (e) {
                    console.log('断开连接失败:', e);
                }
            } else {
                onDisconnected();
            }
        }
        
        // 断开连接处理
        function onDisconnected() {
            statusElement.textContent = "已断开";
            deviceNameElement.textContent = "--";
            connectButton.textContent = "连接蓝牙设备";
            connectButton.disabled = false;
            
            deviceObj = null;
            characteristicObj = null;
        }
        
        // 检查浏览器支持
        if (!navigator.bluetooth) {
            statusElement.textContent = "此浏览器不支持Web蓝牙!";
            connectButton.disabled = true;
            alert("此浏览器不支持Web蓝牙 API。请使用Chrome、Edge或其他支持的浏览器。");
        }
    </script>
</body>
</html>
